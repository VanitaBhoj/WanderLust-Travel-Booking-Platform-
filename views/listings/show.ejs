<% layout("/layouts/boilerplate") %>
<script>
    const mapToken="<%= process.env.MAPBOX_TOKEN %>";
    const coordinates=<%- JSON.stringify(listing.geometry && listing.geometry.coordinates ? listing.geometry.coordinates : null)  %>;
    const placeName = "<%= listing.location %>";

</script>
<div class="container my-5">

    <!-- Listing Header -->
    <div class="text-center mb-5 animate__animated animate__fadeInDown">
        <h2 class="fw-bold display-4 text-gradient"><%= listing.title %></h2>
        <p class="text-muted fst-italic">‚ú® Explore this unique stay ‚ú®</p>
    </div>

    <!-- Listing Card -->
    <div class="card glass-card mx-auto shadow-lg rounded-4 overflow-hidden animate__animated animate__zoomIn" 
         style="max-width: 950px;">
        <img  src="<%= listing.image && listing.image.url ? listing.image.url : '/images/default.jpg' %>"
  class="card-img-top"
  alt="listing_images"
             style="object-fit: cover; max-height: 450px;">

        <div class="card-body p-4">
            <p class="text-muted mb-2"><i class="bi bi-person-circle"></i> 
                <%= listing.owner ? "Owned by " + listing.owner.username : "Unknown Owner" %>
            </p>

            <p class="fs-5 mb-3"><%= listing.description %></p>

            <h3 class="fw-bold text-success mb-2">‚Çπ <%= listing.price %> / night</h3>

            <p class="mb-0 fw-semibold">
                <i class="bi bi-geo-alt-fill text-danger"></i> 
                <%= listing.location %>, <%= listing.country %>
            </p>
        </div>
    </div>

    <!-- Action Buttons -->
    <% if (currUser && listing.owner && listing.owner._id.toString() === currUser._id.toString()) { %>
        <div class="d-flex justify-content-center gap-3 my-4 animate__animated animate__fadeInUp">
            <a href="/listings/<%= listing._id %>/edit" 
               class="btn btn-warning px-4 fw-semibold shadow-lg float-btn">‚úè Edit</a>
            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" 
                  onsubmit="return confirm('Are you sure you want to delete this listing?');">
                <button class="btn btn-danger px-4 fw-semibold shadow-lg float-btn">üóë Delete</button>
            </form>
        </div>
    <% } %>

    <!-- Review Section -->
    <div class="card glass-card mx-auto mt-5 shadow-lg border-0 rounded-4 p-4 animate__animated animate__fadeInUp" 
         style="max-width: 950px;">
        <h3 class="fw-bold text-center mb-4 text-primary">‚≠ê Reviews & Ratings</h3>

        <% if (currUser) { %>
          <hr/>  
        <!-- Review Form -->
        <form action="/listings/<%= listing._id %>/reviews" method="POST" 
              class="needs-validation" novalidate>
            
            <!-- Rating -->
            <fieldset class="starability-slot mb-4 animated-stars">
                <legend class="form-label fw-semibold">Your Rating</legend>

                <input type="radio" id="rate5" name="review[rating]" value="5" />
                <label for="rate5" title="Amazing">5 stars</label>

                <input type="radio" id="rate4" name="review[rating]" value="4" />
                <label for="rate4" title="Very good">4 stars</label>

                <input type="radio" id="rate3" name="review[rating]" value="3" />
                <label for="rate3" title="Average">3 stars</label>

                <input type="radio" id="rate2" name="review[rating]" value="2" />
                <label for="rate2" title="Not good">2 stars</label>

                <input type="radio" id="rate1" name="review[rating]" value="1" />
                <label for="rate1" title="Terrible">1 star</label>
            </fieldset>

            <!-- Comment -->
            <div class="mb-4">
                <label for="comment" class="form-label fw-semibold">Comment</label>
                <textarea name="review[comment]" id="comment" rows="4" 
                          class="form-control border-primary shadow-sm" 
                          placeholder="üí¨ Share your experience..." required></textarea>
                <div class="invalid-feedback">Please add some comments for your review.</div>
            </div>

            <!-- Submit Button -->
            <div class="text-center">
                <button class="btn btn-primary px-5 py-2 fw-semibold shadow-sm float-btn">
                    üöÄ Submit Review
                </button>
            </div>
        </form>
        <% } %>

       <hr class="my-4"/>

<% if (Array.isArray(listing.reviews) && listing.reviews.length > 0) { %>
  <p><b>All Reviews</b></p>

  <div class="row g-4 mt-2">
    <% for (let r of listing.reviews) { %>
      <div class="col-md-6">
        <div class="card review-bubble shadow-lg border-0 rounded-4 h-100 animate__animated animate__fadeInUp">
          <div class="card-body">

            <!-- Reviewer Name -->
            <h6 class="card-title fw-bold text-primary mb-2">
              <i class="bi bi-person-circle"></i>
              <%= r.author ? r.author.username : "Anonymous" %>
            </h6>

            <!-- Rating -->
            <div class="d-flex align-items-center mb-2">
              <p class="starability-result me-2" data-rating="<%= r.rating %>"></p>
              <span class="badge bg-warning text-dark rounded-pill px-3">
                <%= r.rating %> / 5
              </span>
            </div>

            <!-- Comment -->
            <p class="card-text fs-6 mb-0"><%= r.comment %></p>
          </div>

          <!-- Delete Button -->
          <% if (currUser && r.author && currUser._id.toString() === r.author._id.toString()) { %>
            <div class="card-footer bg-transparent border-0 d-flex justify-content-end">
              <form method="POST"
                action="/listings/<%= listing._id %>/reviews/<%= r._id %>?_method=DELETE">
                <button class="btn btn-sm btn-outline-danger px-3 shadow-sm float-btn">
                  üóë Delete
                </button>
              </form>
            </div>
          <% } %>

        </div>
      </div>
    <% } %>
  </div>

<% } else { %>
  <p class="text-muted text-center">No reviews yet. Be the first! üåü</p>
<% } %>
    </div>
    <div class="card glass-card mx-auto mt-5 shadow-lg border-0 rounded-4 p-4 animate__animated animate__fadeInUp" 
         style="max-width: 950px;">
         <h3>Where you'll be</h3>
         <div id="map"></div>
    </div>
    
</div>
<script src="/js/map.js"></script>


<!-- Extra CSS -->
<style>
/* Gradient text */
.text-gradient {
    background: linear-gradient(90deg, #ff512f, #dd2476);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* Glassmorphism card */
.glass-card {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(12px);
}

/* Floating buttons */
.float-btn {
    transition: all 0.3s ease;
    border-radius: 50px;
}
.float-btn:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0px 8px 20px rgba(0,0,0,0.2);
}

/* Review bubbles */
.review-bubble {
    background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.review-bubble:hover {
    transform: translateY(-6px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* Animated stars */
.animated-stars label:hover {
    transform: scale(1.2);
    transition: 0.2s;
    color: gold !important;
}

/* Animate.css (must include in boilerplate or CDN) */
</style>

<!-- Bootstrap Validation Script -->
<script>
(function () {
    'use strict';
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
})();
</script>
